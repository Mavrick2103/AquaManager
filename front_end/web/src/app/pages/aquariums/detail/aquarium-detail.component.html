<section class="toolbar">
  <a class="brand" [routerLink]="['/aquariums']" aria-label="Retour à la liste">
    <img src="/Logo_AquaManger.png" alt="AquaManager" class="logo" />
  </a>

  <h1>Fiche aquarium</h1>

  <div class="actions">
    <button
      mat-stroked-button
      type="button"
      [disabled]="saving"
      (click)="openEditDialog()"
      aria-label="Paramètres de l’aquarium"
    >
      <mat-icon>settings</mat-icon>
      <span>Paramètres</span>
    </button>
  </div>
</section>

<section class="hero" *ngIf="!loading">
  <div class="left">
    <div class="avatar"><mat-icon>water_drop</mat-icon></div>
    <div class="headings">
      <div class="title">{{ form.value.name || '—' }}</div>
      <div class="meta">
        {{ liters }} L
        <span class="dot"></span>
        <mat-chip-set>
          <mat-chip [ngClass]="form.value.waterType === 'EAU_DE_MER' ? 'mer' : 'douce'">
            {{ form.value.waterType === 'EAU_DE_MER' ? 'Eau de mer' : 'Eau douce' }}
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="kpi">
      <div class="kpi-label">Dimensions</div>
      <div class="kpi-value">
        {{ form.value.lengthCm || 0 }} × {{ form.value.widthCm || 0 }} × {{ form.value.heightCm || 0 }} cm
      </div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Mise en eau</div>
      <div class="kpi-value">{{ form.value.startDate || '—' }}</div>
    </div>
  </div>
</section>

<!-- ========= Onglets ========= -->
<mat-tab-group dynamicHeight>
  <mat-tab label="Mesures">
    <div class="tab-section">
      <div class="tab-actions">
        <button mat-raised-button color="primary" (click)="openMeasurementDialog()">
          <mat-icon>add</mat-icon>
          Ajouter une mesure
        </button>
      </div>

      <div class="mini-grid">
        <div class="mini-card">
          <app-water-measurements-chart
            [aquariumId]="id"
            [waterType]="waterType"
            metric="ph">
          </app-water-measurements-chart>
        </div>
        <div class="mini-card">
          <app-water-measurements-chart
            [aquariumId]="id"
            [waterType]="waterType"
            metric="temp">
          </app-water-measurements-chart>
        </div>
        <div class="mini-card">
          <app-water-measurements-chart
            [aquariumId]="id"
            [waterType]="waterType"
            metric="no2">
          </app-water-measurements-chart>
        </div>
        <div class="mini-card">
          <app-water-measurements-chart
            [aquariumId]="id"
            [waterType]="waterType"
            metric="no3">
          </app-water-measurements-chart>
        </div>

        <!-- Eau douce -->
        <ng-container *ngIf="waterType === 'EAU_DOUCE'">
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="kh">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="gh">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="co2">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="po4">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="fe">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="k">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="sio2">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="nh3">
            </app-water-measurements-chart>
          </div>
        </ng-container>

        <!-- Eau de mer -->
        <ng-container *ngIf="waterType === 'EAU_DE_MER'">
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="dkh">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="sal">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="ca">
            </app-water-measurements-chart>
          </div>
          <div class="mini-card">
            <app-water-measurements-chart
              [aquariumId]="id"
              [waterType]="waterType"
              metric="mg">
            </app-water-measurements-chart>
          </div>
        </ng-container>
      </div>

      <!-- ================= Historique des mesures ================= -->
      <section class="history" *ngIf="!loading">
        <div class="history-header">
          <h2>Historique des mesures</h2>

          <mat-form-field appearance="outline" class="limit-select">
            <mat-label>Afficher</mat-label>
            <mat-select [(value)]="selectedLimit" (selectionChange)="applyLimit()">
              <mat-option *ngFor="let n of limitOptions" [value]="n">
                {{ n === 0 ? 'Toutes' : n }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="history-table-wrapper">
          <table mat-table [dataSource]="displayedMeasurements" class="mat-elevation-z0">
            <!-- Date -->
            <ng-container matColumnDef="measuredAt">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let m">{{ m.measuredAt | date: 'medium' }}</td>
            </ng-container>

            <!-- Colonnes communes -->
            <ng-container matColumnDef="ph">
              <th mat-header-cell *matHeaderCellDef>pH</th>
              <td mat-cell *matCellDef="let m">{{ m.ph ?? '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="temp">
              <th mat-header-cell *matHeaderCellDef>Temp (°C)</th>
              <td mat-cell *matCellDef="let m">{{ m.temp ?? '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="no2">
              <th mat-header-cell *matHeaderCellDef>NO₂</th>
              <td mat-cell *matCellDef="let m">{{ m.no2 ?? '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="no3">
              <th mat-header-cell *matHeaderCellDef>NO₃</th>
              <td mat-cell *matCellDef="let m">{{ m.no3 ?? '—' }}</td>
            </ng-container>

            <!-- Eau douce -->
            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="kh">
              <th mat-header-cell *matHeaderCellDef>KH</th>
              <td mat-cell *matCellDef="let m">{{ m.kh ?? '—' }}</td>
            </ng-container>
            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="gh">
              <th mat-header-cell *matHeaderCellDef>GH</th>
              <td mat-cell *matCellDef="let m">{{ m.gh ?? '—' }}</td>
            </ng-container>
            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="po4">
              <th mat-header-cell *matHeaderCellDef>PO₄</th>
              <td mat-cell *matCellDef="let m">{{ m.po4 ?? '—' }}</td>
            </ng-container>
            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="fe">
              <th mat-header-cell *matHeaderCellDef>Fe</th>
              <td mat-cell *matCellDef="let m">{{ m.fe ?? '—' }}</td>
            </ng-container>
            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="k">
              <th mat-header-cell *matHeaderCellDef>K</th>
              <td mat-cell *matCellDef="let m">{{ m.k ?? '—' }}</td>
            </ng-container>

            <!-- Eau de mer -->
            <ng-container *ngIf="waterType === 'EAU_DE_MER'" matColumnDef="dkh">
              <th mat-header-cell *matHeaderCellDef>dKH</th>
              <td mat-cell *matCellDef="let m">{{ m.dkh ?? '—' }}</td>
            </ng-container>
            <ng-container *ngIf="waterType === 'EAU_DE_MER'" matColumnDef="salinity">
              <th mat-header-cell *matHeaderCellDef>Salinité</th>
              <td mat-cell *matCellDef="let m">{{ m.salinity ?? '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let m">
                <button mat-icon-button color="warn" (click)="deleteMeasurement(m.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>

        <p *ngIf="!displayedMeasurements.length" class="history-empty">
          Aucune mesure enregistrée pour le moment.
        </p>
      </section>
    </div>
  </mat-tab>

  <mat-tab label="Espèces">
    <div class="tab-section">
      <div class="tab-actions">
        <button mat-raised-button (click)="addSpecies()">
          <mat-icon>add</mat-icon>
          Ajouter une espèce
        </button>
      </div>

      <mat-list *ngIf="species.length; else emptySpecies">
        <mat-list-item *ngFor="let s of species; let i = index">
          <div matListItemTitle>{{ s.name }}</div>
          <div matListItemLine>Quantité : {{ s.count }}</div>
          <button mat-icon-button color="warn" (click)="removeSpecies(i)" aria-label="Supprimer">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-list-item>
      </mat-list>

      <ng-template #emptySpecies>
        <p style="opacity:.7; margin:16px 0">Aucune espèce enregistrée pour le moment.</p>
      </ng-template>
    </div>
  </mat-tab>
</mat-tab-group>

<ng-template #loader>
  <div class="loading">
    <mat-progress-spinner diameter="56"></mat-progress-spinner>
  </div>
</ng-template>