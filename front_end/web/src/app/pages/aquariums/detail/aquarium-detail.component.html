<section class="toolbar">
  <a class="brand" [routerLink]="['/aquariums']" aria-label="Retour à la liste">
    <img src="/Logo_AquaManger.png" alt="AquaManager" class="logo" />
  </a>

  <h1 class="title-with-icon">
    Fiche aquarium

    <button
      mat-icon-button
      class="settings-mobile"
      type="button"
      [disabled]="saving"
      (click)="openEditDialog()"
      aria-label="Paramètres de l’aquarium"
    >
      <mat-icon>settings</mat-icon>
    </button>
  </h1>

  <div class="actions">
    <button
      mat-stroked-button
      type="button"
      [disabled]="saving"
      (click)="openEditDialog()"
      aria-label="Paramètres de l’aquarium"
    >
      <mat-icon>settings</mat-icon>
      <span>Paramètres</span>
    </button>
  </div>
</section>

<section class="hero" *ngIf="!loading">
  <div class="left">
    <div class="avatar"><mat-icon>water_drop</mat-icon></div>
    <div class="headings">
      <div class="title">{{ form.value.name || '—' }}</div>
      <div class="meta">
        {{ liters }} L
        <span class="dot"></span>
        <mat-chip-set>
          <mat-chip [ngClass]="form.value.waterType === 'EAU_DE_MER' ? 'mer' : 'douce'">
            {{ form.value.waterType === 'EAU_DE_MER' ? 'Eau de mer' : 'Eau douce' }}
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="kpi">
      <div class="kpi-label">Dimensions</div>
      <div class="kpi-value">
        {{ form.value.lengthCm || 0 }} × {{ form.value.widthCm || 0 }} ×
        {{ form.value.heightCm || 0 }} cm
      </div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Mise en eau</div>
      <div class="kpi-value">{{ form.value.startDate || '—' }}</div>
    </div>
  </div>
</section>

<mat-tab-group dynamicHeight class="tabs-group">
  <mat-tab label="Mesures">
    <div class="tab-section">
      <div class="tab-actions">
        <button mat-raised-button color="primary" (click)="openMeasurementDialog()">
          <mat-icon>add</mat-icon>
          <span>Ajouter une mesure</span>
        </button>
      </div>

      <div class="mini-grid">
        <div class="mini-card">
          <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="ph" />
        </div>
        <div class="mini-card">
          <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="temp" />
        </div>
        <div class="mini-card">
          <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="no2" />
        </div>
        <div class="mini-card">
          <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="no3" />
        </div>

        <ng-container *ngIf="waterType === 'EAU_DOUCE'">
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="kh" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="gh" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="co2" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="po4" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="fe" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="k" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="sio2" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="nh3" />
          </div>
        </ng-container>

        <ng-container *ngIf="waterType === 'EAU_DE_MER'">
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="dkh" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="sal" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="ca" />
          </div>
          <div class="mini-card">
            <app-water-measurements-chart [aquariumId]="id" [waterType]="waterType" metric="mg" />
          </div>
        </ng-container>
      </div>

      <section class="history" *ngIf="!loading">
        <div class="history-header">
          <h2>Historique des mesures</h2>

          <mat-form-field appearance="outline" class="limit-select">
            <mat-label>Afficher</mat-label>
            <mat-select [(value)]="selectedLimit" (selectionChange)="applyLimit()">
              <mat-option *ngFor="let n of limitOptions" [value]="n">
                {{ n === 0 ? 'Toutes' : n }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="history-table-wrapper">
          <table mat-table [dataSource]="displayedMeasurements" class="mat-elevation-z0">
            <ng-container matColumnDef="measuredAt">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let m">{{ m.measuredAt | date: 'medium' }}</td>
            </ng-container>

            <ng-container matColumnDef="ph">
              <th mat-header-cell *matHeaderCellDef>pH</th>
              <td mat-cell *matCellDef="let m">{{ m.ph ?? '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="temp">
              <th mat-header-cell *matHeaderCellDef>Temp (°C)</th>
              <td mat-cell *matCellDef="let m">{{ m.temp ?? '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="no2">
              <th mat-header-cell *matHeaderCellDef>NO₂</th>
              <td mat-cell *matCellDef="let m">{{ m.no2 ?? '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="no3">
              <th mat-header-cell *matHeaderCellDef>NO₃</th>
              <td mat-cell *matCellDef="let m">{{ m.no3 ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="kh">
              <th mat-header-cell *matHeaderCellDef>KH</th>
              <td mat-cell *matCellDef="let m">{{ m.kh ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="gh">
              <th mat-header-cell *matHeaderCellDef>GH</th>
              <td mat-cell *matCellDef="let m">{{ m.gh ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="po4">
              <th mat-header-cell *matHeaderCellDef>PO₄</th>
              <td mat-cell *matCellDef="let m">{{ m.po4 ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="fe">
              <th mat-header-cell *matHeaderCellDef>Fe</th>
              <td mat-cell *matCellDef="let m">{{ m.fe ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DOUCE'" matColumnDef="k">
              <th mat-header-cell *matHeaderCellDef>K</th>
              <td mat-cell *matCellDef="let m">{{ m.k ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DE_MER'" matColumnDef="dkh">
              <th mat-header-cell *matHeaderCellDef>dKH</th>
              <td mat-cell *matCellDef="let m">{{ m.dkh ?? '—' }}</td>
            </ng-container>

            <ng-container *ngIf="waterType === 'EAU_DE_MER'" matColumnDef="salinity">
              <th mat-header-cell *matHeaderCellDef>Salinité</th>
              <td mat-cell *matCellDef="let m">{{ m.salinity ?? '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let m">
                <button mat-icon-button color="warn" (click)="deleteMeasurement(m.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>

        <p *ngIf="!displayedMeasurements.length" class="history-empty">
          Aucune mesure enregistrée pour le moment.
        </p>
      </section>
    </div>
  </mat-tab>

  <mat-tab label="Dans mon Aquarium">
    <div class="tab-section">
      <div class="tab-actions">
        <button mat-raised-button (click)="openAddDialog()">
          <mat-icon>add</mat-icon>
          <span>Ajouter</span>
        </button>
      </div>

      <!-- ===== FISH GRID ===== -->
      <h3 class="section-title">Poissons / Vivants</h3>

      <div class="items-grid" *ngIf="fishInTank.length; else emptyFish">
        <a
          class="item-card item-card--link"
          *ngFor="let r of fishInTank"
          [routerLink]="fishDetailsLink(r.fishCard.id)"
        >
          <div class="thumb" *ngIf="fishImageUrl(r); else fishPh">
            <img [src]="fishImageUrl(r)!" [alt]="r.fishCard.commonName" loading="lazy" />
          </div>
          <ng-template #fishPh>
            <div class="thumb placeholder"><mat-icon>pets</mat-icon></div>
          </ng-template>

          <div class="body">
            <div class="top">
              <div class="name">{{ r.fishCard.commonName }}</div>

              <div class="right">
                <div class="qty">x{{ r.count }}</div>
                <mat-icon class="chev" aria-hidden="true">chevron_right</mat-icon>
              </div>
            </div>

            <div class="sub" *ngIf="r.fishCard.scientificName">
              {{ r.fishCard.scientificName }}
            </div>

            <div
              class="params"
              *ngIf="
                r.fishCard.tempMin != null || r.fishCard.tempMax != null ||
                r.fishCard.phMin != null || r.fishCard.phMax != null ||
                r.fishCard.khMin != null || r.fishCard.khMax != null
              "
            >
              <span class="chip" *ngIf="r.fishCard.tempMin != null || r.fishCard.tempMax != null">
                Temp <b>{{ r.fishCard.tempMin ?? '—' }}–{{ r.fishCard.tempMax ?? '—' }}°C</b>
              </span>

              <span class="chip" *ngIf="r.fishCard.phMin != null || r.fishCard.phMax != null">
                pH <b>{{ r.fishCard.phMin ?? '—' }}–{{ r.fishCard.phMax ?? '—' }}</b>
              </span>

              <span class="chip" *ngIf="r.fishCard.khMin != null || r.fishCard.khMax != null">
                KH <b>{{ r.fishCard.khMin ?? '—' }}–{{ r.fishCard.khMax ?? '—' }}</b>
              </span>
            </div>

            <div class="cta">
              <span>Voir la fiche</span>
              <mat-icon aria-hidden="true">open_in_new</mat-icon>
            </div>
          </div>

          <button
            mat-icon-button
            color="warn"
            class="trash"
            (click)="onRemoveFishClick($event, r.id)"
            aria-label="Supprimer"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </a>
      </div>

      <ng-template #emptyFish>
        <p class="empty-species">Aucun poisson/vivant enregistré.</p>
      </ng-template>

      <!-- ===== PLANTS GRID (inchangé visuellement) ===== -->
      <h3 class="section-title section-title--spaced">Plantes</h3>

      <div class="items-grid" *ngIf="plantsInTank.length; else emptyPlants">
        <a class="item-card" *ngFor="let r of plantsInTank" [routerLink]="plantDetailsLink(r.plantCard.id)">
          <div class="thumb" *ngIf="r.plantCard.imageUrl; else plantPh">
            <img [src]="r.plantCard.imageUrl!" alt="" />
          </div>
          <ng-template #plantPh>
            <div class="thumb placeholder"><mat-icon>eco</mat-icon></div>
          </ng-template>

          <div class="body">
            <div class="top">
              <div class="name">{{ r.plantCard.commonName }}</div>
              <div class="qty">x{{ r.count }}</div>
            </div>
            <div class="sub" *ngIf="r.plantCard.scientificName">{{ r.plantCard.scientificName }}</div>
            <div class="hint">Clique pour ouvrir la fiche</div>
          </div>

          <button
            mat-icon-button
            color="warn"
            class="trash"
            (click)="onRemovePlantClick($event, r.id)"
            aria-label="Supprimer"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </a>
      </div>

      <ng-template #emptyPlants>
        <p class="empty-species">Aucune plante enregistrée.</p>
      </ng-template>
    </div>
  </mat-tab>
</mat-tab-group>

<ng-template #loader>
  <div class="loading">
    <mat-progress-spinner diameter="56"></mat-progress-spinner>
  </div>
</ng-template>
