<mat-card class="settings-card">
  <div class="header">
    <a class="brand" routerLink="/">
      <img src="assets/Logo_AquaManager.png" alt="AquaManager" class="logo" />
    </a>
    <h1>Paramètres</h1>
    <span class="spacer"></span>
  </div>

  <p class="hint">Ajustez vos préférences puis cliquez sur <strong>Enregistrer</strong>.</p>

  <form [formGroup]="form" class="grid" *ngIf="form; else loadingTpl">
    <!-- Thème & Affichage -->
    <div class="section">
      <h2><mat-icon>palette</mat-icon> Apparence</h2>
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Thème</mat-label>
          <mat-select formControlName="theme">
            <mat-option value="system">Système</mat-option>
            <mat-option value="light">Clair</mat-option>
            <mat-option value="dark">Sombre</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Vue par défaut</mat-label>
          <mat-select formControlName="defaultView">
            <mat-option value="cards">Cartes</mat-option>
            <mat-option value="table">Tableau</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Unités -->
    <div class="section">
      <h2><mat-icon>straighten</mat-icon> Unités</h2>
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Température</mat-label>
          <mat-select formControlName="temperatureUnit">
            <mat-option value="C">°C</mat-option>
            <mat-option value="F">°F</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Volume</mat-label>
          <mat-select formControlName="volumeUnit">
            <mat-option value="L">Litres</mat-option>
            <mat-option value="GAL">Gallons</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Notifications -->
    <div class="section">
      <h2><mat-icon>notifications</mat-icon> Notifications</h2>
      <div class="row toggles">
        <mat-slide-toggle formControlName="emailNotifications">Email</mat-slide-toggle>
        <mat-slide-toggle formControlName="pushNotifications">Push</mat-slide-toggle>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Alertes & Seuils -->
    <div class="section">
      <h2><mat-icon>alert</mat-icon> Alertes</h2>
      <mat-slide-toggle formControlName="alertsEnabled">Activer les alertes</mat-slide-toggle>

      <div class="row thresholds">
        <mat-form-field appearance="outline">
          <mat-label>pH min</mat-label>
          <input matInput type="number" step="0.1" formControlName="phMin" />
          <mat-error *ngIf="form.hasError('range') && form.get('phMin')?.touched">pH min ≤ pH max</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>pH max</mat-label>
          <input matInput type="number" step="0.1" formControlName="phMax" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Temp. min</mat-label>
          <input matInput type="number" step="0.5" formControlName="tempMin" />
          <mat-hint>°{{ form.get('temperatureUnit')?.value || 'C' }}</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Temp. max</mat-label>
          <input matInput type="number" step="0.5" formControlName="tempMax" />
          <mat-hint>°{{ form.get('temperatureUnit')?.value || 'C' }}</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <div class="actions">
      <button mat-stroked-button type="button" (click)="reset()" [disabled]="loading">
        <mat-icon>refresh</mat-icon> Annuler
      </button>

      <button mat-flat-button color="primary" type="button"
              (click)="save()"
              [disabled]="loading || form.invalid || !hasChanges">
        <mat-icon *ngIf="!loading">save</mat-icon>
        <mat-progress-spinner *ngIf="loading" mode="indeterminate" diameter="18"></mat-progress-spinner>
        Enregistrer
      </button>
    </div>
  </form>

  <ng-template #loadingTpl>
    <div class="loading">
      <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
    </div>
  </ng-template>
</mat-card>
