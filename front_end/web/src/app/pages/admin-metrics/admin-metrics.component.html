<div class="admin-layout">
  <!-- SIDEBAR (IDENTIQUE A ADMIN-USERS) -->
  <aside class="sidebar" role="navigation" aria-label="Menu administration">
    <a class="brand-side" routerLink="/" aria-label="Retour à l’accueil">
      <img
        src="/Logo_AquaManger.png"
        alt="AquaManager"
        class="logo"
        loading="lazy"
        decoding="async"
      />
    </a>

    <div class="sidebar-title">ADMINISTRATION</div>

    <mat-nav-list class="nav">
      <a mat-list-item routerLink="/admin/metrics" routerLinkActive="active">
        <mat-icon matListItemIcon>manage_accounts</mat-icon>
        <span matListItemTitle>Dashboard</span>
      </a>

      <a mat-list-item routerLink="/admin/users" routerLinkActive="active">
        <mat-icon matListItemIcon>group</mat-icon>
        <span matListItemTitle>Utilisateurs</span>
      </a>

      <a mat-list-item routerLink="/admin/species/fish" routerLinkActive="active">
        <mat-icon matListItemIcon>pets</mat-icon>
        <span matListItemTitle>Poissons</span>
      </a>

      <a mat-list-item routerLink="/admin/species/plant" routerLinkActive="active">
        <mat-icon matListItemIcon>local_florist</mat-icon>
        <span matListItemTitle>Plantes</span>
      </a>
    </mat-nav-list>

    <div class="sidebar-footer">
  <a mat-stroked-button class="back-btn" routerLink="/profile" aria-label="Retour au profil">
    <mat-icon>arrow_back</mat-icon>
    Profil
  </a>
</div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="page">
      <mat-toolbar class="toolbar" role="banner">
        <div class="brand">
          <div class="brand-icon">
            <mat-icon>query_stats</mat-icon>
          </div>
          <div class="brand-text">
            <div class="brand-title">Dashboard Admin</div>
            <div class="brand-sub" *ngIf="metrics">
              {{ rangeLabel() }} • Généré le {{ metrics.generatedAt | date:'medium' }}
            </div>
          </div>
        </div>

        <span class="spacer"></span>

        <button mat-stroked-button class="home-btn" routerLink="/" matTooltip="Retour à l’accueil">
          <mat-icon>home</mat-icon>
          Accueil
        </button>

        <mat-button-toggle-group class="range" [value]="range" aria-label="Période">
          <mat-button-toggle value="7d" (click)="setRange('7d')">7j</mat-button-toggle>
          <mat-button-toggle value="30d" (click)="setRange('30d')">30j</mat-button-toggle>
          <mat-button-toggle value="365d" (click)="setRange('365d')">1 an</mat-button-toggle>
          <mat-button-toggle value="all" (click)="setRange('all')">
            <mat-icon class="mini">check</mat-icon>
            Total
          </mat-button-toggle>
        </mat-button-toggle-group>
      </mat-toolbar>

      <div class="state" *ngIf="loading">
        <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
        <span>Chargement…</span>
      </div>

      <div class="state error" *ngIf="error">
        <mat-icon>error</mat-icon>
        <span>{{ error }}</span>
      </div>

      <ng-container *ngIf="metrics && !loading">
        <section class="grid">
          <mat-card class="kpi kpi-users">
            <div class="kpi-top">
              <div class="kpi-icon"><mat-icon>group</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Utilisateurs inscrits</div>
                <div class="kpi-value">{{ metrics.users.total }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="kpi-rows">
              <div class="row"><span>Admins</span><b>{{ metrics.users.admins }}</b></div>
              <div class="row"><span>Actifs (période)</span><b>{{ metrics.users.activeInRange }}</b></div>
              <div class="row"><span>Nouveaux (période)</span><b>{{ kpi(metrics.users.newInRange) }}</b></div>
            </div>

            <div class="note" *ngIf="metrics.users.note">
              <mat-icon>info</mat-icon>
              <span>{{ metrics.users.note }}</span>
            </div>
          </mat-card>

          <mat-card class="kpi kpi-aqua">
            <div class="kpi-top">
              <div class="kpi-icon"><mat-icon>waves</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Aquariums</div>
                <div class="kpi-value">{{ metrics.aquariums.total }}</div>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="kpi-rows">
              <div class="row"><span>Créés (période)</span><b>{{ metrics.aquariums.createdInRange }}</b></div>
            </div>
          </mat-card>

          <mat-card class="kpi kpi-measures">
            <div class="kpi-top">
              <div class="kpi-icon"><mat-icon>science</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Mesures</div>
                <div class="kpi-value">{{ metrics.measurements.total }}</div>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="kpi-rows">
              <div class="row"><span>Ajoutées (période)</span><b>{{ metrics.measurements.createdInRange }}</b></div>
            </div>
          </mat-card>

          <mat-card class="kpi kpi-tasks">
            <div class="kpi-top">
              <div class="kpi-icon"><mat-icon>checklist</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Tâches</div>
                <div class="kpi-value">{{ metrics.tasks.total }}</div>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="kpi-rows">
              <div class="row"><span>Créées (période)</span><b>{{ metrics.tasks.createdInRange }}</b></div>
              <div class="row"><span>DONE (total)</span><b>{{ metrics.tasks.doneTotal }}</b></div>
              <div class="row"><span>DONE (période)</span><b>{{ metrics.tasks.doneInRange }}</b></div>
            </div>
          </mat-card>
        </section>

        <mat-card class="table-card">
          <div class="table-head">
            <div>
              <h2>Derniers utilisateurs</h2>
              <p>Affichage trié (id/createdAt). Pour “tous”, on fera une page dédiée avec pagination.</p>
            </div>
            <mat-icon>manage_accounts</mat-icon>
          </div>

          <div class="table-wrap">
            <table mat-table [dataSource]="metrics.users.latest" class="mat-elevation-z0">
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let u">{{ u.id }}</td>
              </ng-container>

              <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef>Nom</th>
                <td mat-cell *matCellDef="let u">{{ u.fullName }}</td>
              </ng-container>

              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>Email</th>
                <td mat-cell *matCellDef="let u">{{ u.email }}</td>
              </ng-container>

              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef>Rôle</th>
                <td mat-cell *matCellDef="let u">
                  <mat-chip-set>
                    <mat-chip class="chip" [class.admin]="u.role === 'ADMIN'">{{ u.role }}</mat-chip>
                  </mat-chip-set>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
        </mat-card>
      </ng-container>
    </div>
  </main>
</div>
