<mat-card class="wrap">
  <div class="top">
    <button mat-stroked-button type="button" (click)="back()">
      <mat-icon>arrow_back</mat-icon>
      Retour
    </button>

    <div class="title">
      <h2>Statistiques</h2>
      <p>Article #{{ articleId }}</p>
    </div>

    <button mat-flat-button color="primary" type="button" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
      Actualiser
    </button>
  </div>

  <div class="loading" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="22"></mat-progress-spinner>
    <span>Chargement…</span>
  </div>

  <ng-container *ngIf="!loading && stats">
    <!-- ===== CONTROLES ===== -->
    <div class="controls">
      <div class="ctrl">
        <div class="ctrl-label">Période analysée</div>
        <mat-button-toggle-group
          class="range-toggle"
          [value]="rangeDays"
          (change)="onRangeChange($event.value)"
        >
          <mat-button-toggle [value]="7">7 jours</mat-button-toggle>
          <mat-button-toggle [value]="30">30 jours</mat-button-toggle>
          <mat-button-toggle [value]="90">90 jours</mat-button-toggle>
          <mat-button-toggle [value]="365">365 jours</mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <div class="ctrl">
        <div class="ctrl-label">Regrouper par</div>
        <mat-button-toggle-group
          class="period-toggle"
          [value]="period"
          (change)="onPeriodChange($event.value)"
        >
          <mat-button-toggle value="week">Semaine</mat-button-toggle>
          <mat-button-toggle value="month">Mois</mat-button-toggle>
          <mat-button-toggle value="year">Année</mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>

    <!-- ===== KPIs (clairs) ===== -->
    <div class="kpis kpis-5">
      <div class="kpi">
        <div class="k">Vues totales (depuis toujours)</div>
        <div class="v">{{ stats.totalViewsAllTime }}</div>
      </div>

      <div class="kpi">
        <div class="k">Vues sur {{ stats.days }} jours</div>
        <div class="v">{{ stats.totalViewsPeriod }}</div>
      </div>

      <div class="kpi">
        <div class="k">Uniques sur {{ stats.days }} jours</div>
        <div class="v">{{ stats.totalUniquePeriod }}</div>
      </div>

      <div class="kpi">
        <div class="k">Moyenne / jour</div>
        <div class="v">{{ avgViewsPerDay }}</div>
      </div>

      <div class="kpi">
        <div class="k">Meilleur jour</div>
        <div class="v small">{{ bestDayLabel }}</div>
        <div class="sub">{{ bestDayViews }} vues</div>
      </div>
    </div>

    <!-- ===== GRAPH 1 : DAILY ===== -->
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">
          <h3>Vues par jour</h3>
          <p>Chaque point = 1 journée (format {{ '21/03/2025' }})</p>
        </div>
      </div>

      <div class="chart chart-lg">
        <canvas
          baseChart
          [type]="dailyChartType"
          [data]="dailyChartData"
          [options]="dailyChartOptions"
        ></canvas>
      </div>
    </div>

    <!-- ===== GRAPH 2 : GROUPED ===== -->
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">
          <h3>Vues regroupées</h3>
          <p>{{ groupedLegend }}</p>
        </div>
      </div>

      <div class="chart chart-md">
        <canvas
          baseChart
          [type]="groupedChartType"
          [data]="groupedChartData"
          [options]="groupedChartOptions"
        ></canvas>
      </div>
    </div>

    <!-- ===== tableau brut ===== -->
    <div class="table">
      <div class="row head">
        <div>Date</div>
        <div>Vues</div>
        <div>Uniques</div>
      </div>

      <div class="row" *ngFor="let d of stats.daily">
        <div>{{ formatDay(d.day) }}</div>
        <div>{{ d.views }}</div>
        <div>{{ d.uniqueViews }}</div>
      </div>
    </div>
  </ng-container>

  <div class="empty" *ngIf="!loading && !stats">
    Aucune donnée.
  </div>
</mat-card>
