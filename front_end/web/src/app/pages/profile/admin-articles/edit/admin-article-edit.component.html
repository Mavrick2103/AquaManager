<mat-card class="wrap">
  <div class="top">
    <button mat-stroked-button type="button" (click)="back()">
      <mat-icon>arrow_back</mat-icon>
      Retour
    </button>

    <div class="title">
      <h2>Modifier l’article</h2>
      <p *ngIf="article">
        #{{ article.id }} • {{ article.slug }}
        <span class="badge" [class.pub]="article.status==='PUBLISHED'" [class.draft]="article.status==='DRAFT'"
              [class.pending]="article.status==='PENDING_REVIEW'" [class.rejected]="article.status==='REJECTED'">
          {{ statusLabel(article.status) }}
        </span>
      </p>
    </div>

    <button mat-stroked-button type="button" (click)="openPublic()" [disabled]="!article">
      <mat-icon>open_in_new</mat-icon>
      Voir public
    </button>
  </div>

  <div class="loading" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="22"></mat-progress-spinner>
    <span>Chargement…</span>
  </div>

  <form *ngIf="!loading" class="form" [formGroup]="form" (ngSubmit)="save()">
    <div class="grid">
      <mat-form-field appearance="outline" class="span2">
        <mat-label>Titre *</mat-label>
        <input matInput formControlName="title" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="span2">
        <mat-label>Syntèse</mat-label>
        <input matInput formControlName="excerpt" />
      </mat-form-field>

      <!-- ✅ STATUT :
           - ADMIN: choix complet
           - EDITOR: lecture seule (affiché mais non modifiable) -->
      <ng-container *ngIf="isAdmin; else editorStatus">
        <mat-form-field appearance="outline">
          <mat-label>Statut *</mat-label>
          <mat-select formControlName="status">
            <mat-option value="DRAFT">Brouillon</mat-option>
            <mat-option value="PENDING_REVIEW">En attente</mat-option>
            <mat-option value="PUBLISHED">Publié</mat-option>
            <mat-option value="REJECTED">Refusé</mat-option>
          </mat-select>
        </mat-form-field>
      </ng-container>

      <ng-template #editorStatus>
        <mat-form-field appearance="outline">
          <mat-label>Statut</mat-label>
          <input matInput [value]="article ? statusLabel(article.status) : ''" disabled />
        </mat-form-field>
      </ng-template>

      <mat-form-field appearance="outline">
        <mat-label>Thème *</mat-label>
        <mat-select formControlName="themeId">
          <mat-option *ngFor="let t of themes" [value]="t.id">{{ t.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="span2">
        <mat-label>Cover image URL</mat-label>
        <input matInput formControlName="coverImageUrl" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="span2">
        <mat-label>Contenu *</mat-label>
        <textarea matInput rows="12" formControlName="content"></textarea>
      </mat-form-field>
    </div>

    <div class="actions">
      <button *ngIf="!isEditor && isAdmin" mat-flat-button color="primary" type="submit" [disabled]="saving || deleting || actioning">
        <mat-icon>save</mat-icon>
        {{ saving ? 'Sauvegarde…' : 'Sauvegarder' }}
      </button>

      <!-- ✅ EDITOR : bouton submit -->
      <button
        *ngIf="isEditor && !isAdmin"
        mat-stroked-button
        color="primary"
        type="button"
        (click)="submitForReview()"
        [disabled]="saving || deleting || actioning || !article"
      >
        <mat-icon>send</mat-icon>
        Envoyer à validation
      </button>

      <!-- ✅ ADMIN : approve/reject si pending -->
      <button
        *ngIf="isAdmin && article?.status === 'PENDING_REVIEW'"
        mat-flat-button
        color="primary"
        type="button"
        (click)="approve()"
        [disabled]="saving || deleting || actioning"
      >
        <mat-icon>check</mat-icon>
        Valider & publier
      </button>

      <button
        *ngIf="isAdmin && article?.status === 'PENDING_REVIEW'"
        mat-stroked-button
        color="warn"
        type="button"
        (click)="reject()"
        [disabled]="saving || deleting || actioning"
      >
        <mat-icon>block</mat-icon>
        Refuser
      </button>

      <!-- delete : idéalement admin only (mais ton back le force déjà). -->
      <button
        mat-stroked-button
        color="warn"
        type="button"
        (click)="delete()"
        [disabled]="saving || deleting || actioning"
      >
        <mat-icon>delete</mat-icon>
        {{ deleting ? 'Suppression…' : 'Supprimer' }}
      </button>
    </div>
  </form>
</mat-card>
