<!-- admin-plant-cards.component.html -->
<div class="admin-layout">
  <aside class="sidebar" role="navigation" aria-label="Menu administration">
    <a class="brand" routerLink="/" aria-label="Retour à l’accueil">
      <img
        src="/Logo_AquaManger.png"
        alt="AquaManager"
        class="logo"
        loading="lazy"
        decoding="async"
      />
    </a>

    <div class="sidebar-title">ADMINISTRATION</div>

    <mat-nav-list class="nav">
      <!-- ✅ ADMIN ONLY -->
      <a
        *ngIf="isAdmin"
        mat-list-item
        routerLink="/admin/metrics"
        routerLinkActive="active"
      >
        <mat-icon matListItemIcon>manage_accounts</mat-icon>
        <span matListItemTitle>Dashboard</span>
      </a>

      <!-- ✅ ADMIN ONLY -->
      <a
        *ngIf="isAdmin"
        mat-list-item
        routerLink="/admin/users"
        routerLinkActive="active"
      >
        <mat-icon matListItemIcon>group</mat-icon>
        <span matListItemTitle>Utilisateurs</span>
      </a>

      <!-- ✅ ADMIN + EDITOR -->
      <a
        *ngIf="isAdmin || isEditor"
        mat-list-item
        routerLink="/admin/species/fish"
        routerLinkActive="active"
      >
        <mat-icon matListItemIcon>pets</mat-icon>
        <span matListItemTitle>Poissons</span>
      </a>

      <!-- ✅ ADMIN + EDITOR -->
      <a
        *ngIf="isAdmin || isEditor"
        mat-list-item
        routerLink="/admin/species/plant"
        routerLinkActive="active"
      >
        <mat-icon matListItemIcon>local_florist</mat-icon>
        <span matListItemTitle>Plantes</span>
      </a>

      <!-- ✅ ADMIN + EDITOR -->
      <a
        *ngIf="isAdmin || isEditor"
        mat-list-item
        routerLink="/admin/articles"
        routerLinkActive="active"
      >
        <mat-icon matListItemIcon>tips_and_updates</mat-icon>
        <span matListItemTitle>Articles / Conseils</span>
      </a>
    </mat-nav-list>

    <div class="sidebar-footer">
      <a
        mat-stroked-button
        class="back-btn"
        routerLink="/profile"
        aria-label="Retour au profil"
      >
        <mat-icon>arrow_back</mat-icon>
        Profil
      </a>
    </div>
  </aside>

  <main class="content">
    <div class="page">
      <div class="header">
        <div class="titles">
          <div class="title">Fiches Plantes</div>
          <div class="subtitle">
            {{ isAdmin ? 'Admin : CRUD + modération' : 'Éditeur : tes fiches uniquement (validation admin)' }}
          </div>
        </div>
      </div>

      <mat-card class="tabs">
        <mat-tab-group [(selectedIndex)]="tabIndex" animationDuration="0ms">
          <!-- LISTE -->
          <mat-tab label="Liste">
            <div class="tab-page">
              <div class="toolbar">
                <div class="left">
                  <div class="mode">Liste des plantes</div>
                  <div class="muted small">Dernières créations en premier</div>
                </div>

                <div class="toolbar-actions">
                  <mat-form-field class="search" appearance="outline">
                    <mat-label>Rechercher (tous critères)</mat-label>
                    <input matInput [value]="search" (input)="onSearchChange($event)" />
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>

                  <!-- ✅ ADMIN ONLY : filtre "En attente" -->
                  <button
                    *ngIf="isAdmin"
                    type="button"
                    mat-stroked-button
                    color="primary"
                    (click)="togglePendingOnly()"
                    [disabled]="loading"
                    [class.active]="showPendingOnly"
                    aria-label="Filtrer les fiches en attente"
                  >
                    <mat-icon>hourglass_top</mat-icon>
                    {{ showPendingOnly ? 'En attente : ON' : 'En attente' }}
                  </button>

                  <button mat-flat-button color="primary" type="button" (click)="newCard()">
                    <mat-icon>add</mat-icon>
                    Nouvelle fiche
                  </button>

                  <button mat-stroked-button type="button" (click)="refresh()" [disabled]="loading">
                    <mat-icon>refresh</mat-icon>
                    Rafraîchir
                  </button>
                </div>
              </div>

              <div class="meta">
                <div class="count">{{ filtered.length }} fiche(s)</div>
                <div class="hint" *ngIf="loading">Chargement...</div>
              </div>

              <div class="grid" *ngIf="filtered.length; else empty">
                <mat-card
                  class="card"
                  *ngFor="let r of filtered"
                  (click)="selectRow(r)"
                  [class.active]="selected?.id === r.id"
                >
                  <div class="card-top">
                    <div class="thumb" [class.no]="!r.imageUrl">
                      <ng-container *ngIf="imageSrc(r.imageUrl) as src; else noThumb">
                        <img [src]="src" (error)="onImgError()" />
                      </ng-container>
                      <ng-template #noThumb>IMG</ng-template>
                    </div>

                    <div class="head">
                      <div class="name">
                        {{ r.commonName }}
                        <span class="id">#{{ r.id }}</span>
                      </div>

                      <div class="sub">
                        <span class="pill">{{ r.waterType }}</span>
                        <span class="pill" *ngIf="r.category">{{ r.category }}</span>
                        <span class="pill" *ngIf="r.growthRate">{{ r.growthRate }}</span>

                        <!-- ✅ status -->
                        <span class="pill" *ngIf="r.status">{{ badgeLabel(r.status) }}</span>
                      </div>

                      <div class="muted small" *ngIf="r.scientificName">{{ r.scientificName }}</div>
                      <div class="muted small" *ngIf="r.rejectReason">Motif : {{ r.rejectReason }}</div>
                    </div>
                  </div>

                  <div class="quick">
                    <div class="q">
                      <div class="k">Placement</div>
                      <div class="v">{{ r.placement || '—' }}</div>
                    </div>
                    <div class="q">
                      <div class="k">Taille max</div>
                      <div class="v">{{ r.maxHeightCm ?? '—' }} cm</div>
                    </div>
                  </div>

                  <div class="card-actions">
                    <button
                      mat-stroked-button
                      color="primary"
                      type="button"
                      (click)="$event.stopPropagation(); selectRow(r)"
                    >
                      <mat-icon>edit</mat-icon>
                      Modifier
                    </button>
                  </div>
                </mat-card>
              </div>

              <ng-template #empty>
                <div class="empty">Aucune fiche plante.</div>
              </ng-template>
            </div>
          </mat-tab>

          <!-- CREATE / EDIT -->
          <mat-tab [label]="selected ? 'Édition' : 'Création'">
            <div class="tab-page">
              <div class="toolbar">
                <div class="left">
                  <div class="mode">
                    {{ selected ? ('Modifier : #' + selected.id) : 'Créer une fiche plante' }}
                  </div>
                  <div class="muted small">
                    {{ selected ? 'Clique une fiche dans la liste pour l’éditer' : 'Formulaire + preview' }}
                  </div>
                </div>

                <div class="toolbar-actions">
                  <!-- ✅ Admin moderation -->
                  <button
                    mat-stroked-button
                    color="primary"
                    type="button"
                    *ngIf="isAdmin && selected"
                    (click)="approveSelected()"
                    [disabled]="saving || uploading"
                  >
                    <mat-icon>check_circle</mat-icon>
                    Approuver
                  </button>

                  <button
                    mat-stroked-button
                    color="warn"
                    type="button"
                    *ngIf="isAdmin && selected"
                    (click)="rejectSelected()"
                    [disabled]="saving || uploading"
                  >
                    <mat-icon>cancel</mat-icon>
                    Rejeter
                  </button>

                  <button
                    mat-stroked-button
                    color="warn"
                    type="button"
                    *ngIf="selected"
                    (click)="deleteSelected()"
                    [disabled]="saving || uploading"
                  >
                    <mat-icon>delete</mat-icon>
                    Supprimer
                  </button>
                </div>
              </div>

              <div class="editor">
                <mat-card class="form">
                  <form (ngSubmit)="submit()" [formGroup]="form">
                    <!-- Identité -->
                    <div class="section">
                      <div class="section-title">Identité</div>

                      <div class="grid-form">
                        <mat-form-field appearance="outline" class="span2">
                          <mat-label>Nom commun *</mat-label>
                          <input matInput formControlName="commonName" />
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="span2">
                          <mat-label>Nom scientifique</mat-label>
                          <input matInput formControlName="scientificName" />
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="span2">
                          <mat-label>Famille</mat-label>
                          <input matInput formControlName="family" />
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="span2">
                          <mat-label>Origine</mat-label>
                          <input matInput formControlName="origin" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Type d’eau *</mat-label>
                          <mat-select formControlName="waterType">
                            <mat-option *ngFor="let t of waterTypes" [value]="t">{{ t }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Catégorie</mat-label>
                          <mat-select formControlName="category">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of categories" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Placement</mat-label>
                          <mat-select formControlName="placement">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of placements" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Vitesse</mat-label>
                          <mat-select formControlName="growthRate">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of growthRates" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Taille max (cm)</mat-label>
                          <input matInput type="number" formControlName="maxHeightCm" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Propagation</mat-label>
                          <mat-select formControlName="propagation">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of propagations" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>

                    <mat-divider class="divider"></mat-divider>

                    <!-- Exigences -->
                    <div class="section">
                      <div class="section-title">Exigences</div>

                      <div class="grid-form">
                        <mat-form-field appearance="outline">
                          <mat-label>Lumière</mat-label>
                          <mat-select formControlName="light">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of lights" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>CO2</mat-label>
                          <mat-select formControlName="co2">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of co2s" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Difficulté</mat-label>
                          <mat-select formControlName="difficulty">
                            <mat-option [value]="null">—</mat-option>
                            <mat-option *ngFor="let x of difficulties" [value]="x">{{ x }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-slide-toggle formControlName="isActive">Active</mat-slide-toggle>
                      </div>
                    </div>

                    <mat-divider class="divider"></mat-divider>

                    <!-- Paramètres d’eau -->
                    <div class="section">
                      <div class="section-title">Paramètres d’eau</div>

                      <div class="grid-form">
                        <mat-form-field appearance="outline">
                          <mat-label>Temp min</mat-label>
                          <input matInput type="number" formControlName="tempMin" />
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Temp max</mat-label>
                          <input matInput type="number" formControlName="tempMax" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>pH min</mat-label>
                          <input matInput type="number" formControlName="phMin" />
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>pH max</mat-label>
                          <input matInput type="number" formControlName="phMax" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>GH min</mat-label>
                          <input matInput type="number" formControlName="ghMin" />
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>GH max</mat-label>
                          <input matInput type="number" formControlName="ghMax" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>KH min</mat-label>
                          <input matInput type="number" formControlName="khMin" />
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>KH max</mat-label>
                          <input matInput type="number" formControlName="khMax" />
                        </mat-form-field>
                      </div>
                    </div>

                    <mat-divider class="divider"></mat-divider>

                    <!-- Nutriments -->
                    <div class="section">
                      <div class="section-title">Nutriments</div>

                      <div class="grid-form">
                        <mat-slide-toggle formControlName="needsFe">Besoin Fe</mat-slide-toggle>
                        <mat-slide-toggle formControlName="needsNo3">Besoin NO3</mat-slide-toggle>
                        <mat-slide-toggle formControlName="needsPo4">Besoin PO4</mat-slide-toggle>
                        <mat-slide-toggle formControlName="needsK">Besoin K</mat-slide-toggle>
                        <mat-slide-toggle formControlName="substrateRequired">Substrat requis</mat-slide-toggle>
                      </div>
                    </div>

                    <mat-divider class="divider"></mat-divider>

                    <!-- Maintenance -->
                    <div class="section">
                      <div class="section-title">Maintenance</div>

                      <div class="grid-text">
                        <mat-form-field appearance="outline">
                          <mat-label>Taille / entretien</mat-label>
                          <textarea matInput rows="3" formControlName="trimming"></textarea>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Compatibilité</mat-label>
                          <input matInput formControlName="compatibility" />
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Notes</mat-label>
                          <textarea matInput rows="3" formControlName="notes"></textarea>
                        </mat-form-field>
                      </div>
                    </div>

                    <mat-divider class="divider"></mat-divider>

                    <!-- Image -->
                    <div class="section">
                      <div class="section-title">Image</div>

                      <div class="img-actions" *ngIf="!selected">
                        <input #fileCreate type="file" accept="image/*" hidden (change)="onFileSelectedCreate($event)" />
                        <button mat-stroked-button type="button" (click)="pickImage(fileCreate)" [disabled]="saving">
                          <mat-icon>upload</mat-icon>
                          Choisir une image
                        </button>

                        <button mat-stroked-button type="button" (click)="removeImage()" [disabled]="saving">
                          <mat-icon>close</mat-icon>
                          Retirer
                        </button>

                        <span class="muted small" *ngIf="pendingCreateFile">{{ pendingCreateFile.name }}</span>
                      </div>

                      <div class="img-actions" *ngIf="selected">
                        <input #fileEdit type="file" accept="image/*" hidden (change)="onFileSelectedEdit($event)" />
                        <button mat-stroked-button type="button" (click)="pickImage(fileEdit)" [disabled]="uploading || saving">
                          <mat-icon>upload</mat-icon>
                          {{ uploading ? 'Import...' : 'Importer' }}
                        </button>

                        <button mat-stroked-button type="button" (click)="removeImage()" [disabled]="uploading || saving">
                          <mat-icon>close</mat-icon>
                          Retirer
                        </button>
                      </div>
                    </div>

                    <div class="actions">
                      <button mat-flat-button color="primary" type="submit" [disabled]="saving || uploading">
                        <mat-icon>save</mat-icon>
                        {{ selected ? 'Enregistrer' : 'Créer' }}
                      </button>

                      <button mat-stroked-button type="button" (click)="tabIndex = 0" [disabled]="saving || uploading">
                        <mat-icon>list</mat-icon>
                        Retour liste
                      </button>
                    </div>
                  </form>
                </mat-card>

                <!-- PREVIEW -->
                <div class="preview">
                  <mat-card class="preview-card">
                    <div class="preview-head">
                      <div>
                        <div class="p-title">{{ form.get('commonName')?.value || 'Nom commun' }}</div>
                        <div class="p-sub">{{ form.get('scientificName')?.value || 'Nom scientifique' }}</div>
                        <div class="p-pill">{{ form.get('waterType')?.value }}</div>

                        <div class="muted small" *ngIf="selected?.status">
                          Statut : {{ badgeLabel(selected?.status) }}
                        </div>
                        <div class="muted small" *ngIf="selected?.rejectReason">
                          Motif : {{ selected?.rejectReason }}
                        </div>
                      </div>

                      <div class="p-img">
                        <ng-container *ngIf="imageSrc(form.get('imageUrl')?.value) as src; else noImg">
                          <img [src]="src" (error)="onImgError()" />
                        </ng-container>
                        <ng-template #noImg>
                          <div class="no-img">
                            <div class="t">Pas d’image</div>
                            <div class="s">uploads / url</div>
                          </div>
                        </ng-template>
                      </div>
                    </div>

                    <div class="preview-body">
                      <div class="block">
                        <div class="bt">Type & placement</div>
                        <div class="kv">
                          <div class="k">Catégorie</div><div class="v">{{ form.get('category')?.value || '—' }}</div>
                          <div class="k">Placement</div><div class="v">{{ form.get('placement')?.value || '—' }}</div>
                          <div class="k">Vitesse</div><div class="v">{{ form.get('growthRate')?.value || '—' }}</div>
                          <div class="k">Taille max</div><div class="v">{{ form.get('maxHeightCm')?.value ?? '—' }} cm</div>
                          <div class="k">Propagation</div><div class="v">{{ form.get('propagation')?.value || '—' }}</div>
                        </div>
                      </div>

                      <div class="block">
                        <div class="bt">Exigences</div>
                        <div class="mini-grid">
                          <div class="mini"><div class="k">Lumière</div><div class="v">{{ form.get('light')?.value || '—' }}</div></div>
                          <div class="mini"><div class="k">CO2</div><div class="v">{{ form.get('co2')?.value || '—' }}</div></div>
                          <div class="mini"><div class="k">Difficulté</div><div class="v">{{ form.get('difficulty')?.value || '—' }}</div></div>
                          <div class="mini"><div class="k">Active</div><div class="v">{{ form.get('isActive')?.value ? 'Oui' : 'Non' }}</div></div>
                        </div>
                      </div>

                      <div class="block">
                        <div class="bt">Eau</div>
                        <div class="kv">
                          <div class="k">Temp</div><div class="v">{{ form.get('tempMin')?.value ?? '—' }} / {{ form.get('tempMax')?.value ?? '—' }}</div>
                          <div class="k">pH</div><div class="v">{{ form.get('phMin')?.value ?? '—' }} / {{ form.get('phMax')?.value ?? '—' }}</div>
                          <div class="k">GH</div><div class="v">{{ form.get('ghMin')?.value ?? '—' }} / {{ form.get('ghMax')?.value ?? '—' }}</div>
                          <div class="k">KH</div><div class="v">{{ form.get('khMin')?.value ?? '—' }} / {{ form.get('khMax')?.value ?? '—' }}</div>
                        </div>
                      </div>

                      <div class="block">
                        <div class="bt">Nutriments</div>
                        <div class="mini-grid">
                          <div class="mini"><div class="k">Fe</div><div class="v">{{ form.get('needsFe')?.value ? 'Oui' : '—' }}</div></div>
                          <div class="mini"><div class="k">NO3</div><div class="v">{{ form.get('needsNo3')?.value ? 'Oui' : '—' }}</div></div>
                          <div class="mini"><div class="k">PO4</div><div class="v">{{ form.get('needsPo4')?.value ? 'Oui' : '—' }}</div></div>
                          <div class="mini"><div class="k">K</div><div class="v">{{ form.get('needsK')?.value ? 'Oui' : '—' }}</div></div>
                          <div class="mini"><div class="k">Substrat</div><div class="v">{{ form.get('substrateRequired')?.value ? 'Oui' : '—' }}</div></div>
                        </div>
                      </div>

                      <div class="block">
                        <div class="bt">Maintenance</div>
                        <div class="txt">
                          <div class="k">Taille / entretien</div>
                          <div class="v">{{ form.get('trimming')?.value || '—' }}</div>
                        </div>
                        <div class="txt">
                          <div class="k">Compatibilité</div>
                          <div class="v">{{ form.get('compatibility')?.value || '—' }}</div>
                        </div>
                        <div class="txt">
                          <div class="k">Notes</div>
                          <div class="v">{{ form.get('notes')?.value || '—' }}</div>
                        </div>
                      </div>
                    </div>
                  </mat-card>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>
  </main>
</div>
