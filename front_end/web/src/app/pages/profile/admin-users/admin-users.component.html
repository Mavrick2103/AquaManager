<div class="admin-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" role="navigation" aria-label="Menu administration">
    <a class="brand" routerLink="/" aria-label="Retour à l’accueil">
      <img
        src="/Logo_AquaManger.png"
        alt="AquaManager"
        class="logo"
        loading="lazy"
        decoding="async"
      />
    </a>

    <div class="sidebar-title">ADMINISTRATION</div>

    <mat-nav-list class="nav">
      <a mat-list-item routerLink="/admin/metrics" routerLinkActive="active">
        <mat-icon matListItemIcon>manage_accounts</mat-icon>
        <span matListItemTitle>Dashboard</span>
      </a>

      <a mat-list-item routerLink="/admin/users" routerLinkActive="active">
        <mat-icon matListItemIcon>group</mat-icon>
        <span matListItemTitle>Utilisateurs</span>
      </a>

      <a mat-list-item routerLink="/admin/species/fish" routerLinkActive="active">
        <mat-icon matListItemIcon>pets</mat-icon>
        <span matListItemTitle>Poissons</span>
      </a>

      <a mat-list-item routerLink="/admin/species/plant" routerLinkActive="active">
        <mat-icon matListItemIcon>local_florist</mat-icon>
        <span matListItemTitle>Plantes</span>
      </a>

      <a mat-list-item routerLink="/admin/articles" routerLinkActive="active">
        <mat-icon matListItemIcon>tips_and_updates</mat-icon>
        <span matListItemTitle>Articles / Conseils</span>
      </a>
    </mat-nav-list>

    <div class="sidebar-footer">
      <a mat-stroked-button class="back-btn" routerLink="/profile" aria-label="Retour au profil">
        <mat-icon>arrow_back</mat-icon>
        Profil
      </a>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <mat-card class="admin-card" role="main">
      <header class="admin-header">
        <div class="titles">
          <h2>Gestion des utilisateurs</h2>
          <p class="subtitle">Clique une ligne pour ouvrir la fiche utilisateur.</p>
        </div>

        <mat-form-field appearance="fill" class="search">
          <mat-label>Rechercher (id, nom, email)</mat-label>
          <input matInput [formControl]="searchCtrl" placeholder="ex: 12, romain, test@mail.com" />
          <button
            *ngIf="searchCtrl.value"
            matSuffix
            mat-icon-button
            (click)="clearSearch()"
            aria-label="Effacer"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <div class="filters">
          <mat-slide-toggle [formControl]="activeOnlyCtrl">Actifs uniquement</mat-slide-toggle>
          <mat-slide-toggle [formControl]="adminOnlyCtrl">Admin uniquement</mat-slide-toggle>
        </div>
      </header>

      <mat-divider class="divider"></mat-divider>

      <!-- LOADING -->
      <div *ngIf="loading" class="loading">
        <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
        <span>Chargement...</span>
      </div>

      <!-- EMPTY -->
      <div *ngIf="!loading && (!filteredUsers || filteredUsers.length === 0)" class="empty">
        <mat-icon>group_off</mat-icon>
        <div>
          <p class="empty-title">Aucun utilisateur</p>
          <p class="empty-sub">Essaie une autre recherche / filtre.</p>
        </div>
      </div>

      <!-- =========================
           DESKTOP / TABLETTE : TABLE
           ========================= -->
      <div class="table-wrap table-desktop" *ngIf="!loading && filteredUsers?.length">
        <table mat-table [dataSource]="filteredUsers" class="users-table" [trackBy]="trackById">
          <!-- ID -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let u" class="mono id-cell">{{ u.id }}</td>
          </ng-container>

          <!-- createdAt -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Inscription</th>
            <td mat-cell *matCellDef="let u">{{ formatDate(u.createdAt) }}</td>
          </ng-container>

          <!-- fullName -->
          <ng-container matColumnDef="fullName">
            <th mat-header-cell *matHeaderCellDef>Nom</th>
            <td mat-cell *matCellDef="let u">
              <div class="name-cell">
                <mat-icon class="avatar">person</mat-icon>
                <span class="name">{{ u.fullName || '—' }}</span>
              </div>
            </td>
          </ng-container>

          <!-- email -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let u" class="mono email-cell" [matTooltip]="u.email">
              {{ u.email }}
            </td>
          </ng-container>

          <!-- role -->
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Rôle</th>

            <td mat-cell *matCellDef="let u" (click)="$event.stopPropagation()">
              <div class="role-cell" [class.saving]="isSaving(u)">
                <!-- Badge cliquable -->
                <button
                  type="button"
                  class="role-badge"
                  [class.admin]="u.role === 'ADMIN'"
                  [class.editor]="u.role === 'EDITOR'"
                  [matMenuTriggerFor]="roleMenu"
                  (click)="$event.stopPropagation()"
                  [disabled]="isSaving(u)"
                  aria-label="Changer le rôle"
                >
                  <mat-icon class="role-badge-ic">
                    {{ u.role === 'ADMIN' ? 'verified_user' : (u.role === 'EDITOR' ? 'edit' : 'person') }}
                  </mat-icon>
                  {{ u.role }}
                  <mat-icon class="chev">expand_more</mat-icon>
                </button>

                <!-- Menu -->
                <mat-menu #roleMenu="matMenu" class="role-menu">
                  <button mat-menu-item *ngFor="let r of roleOptions" (click)="setRole(u, r.value)">
                    <mat-icon>{{ r.icon }}</mat-icon>
                    <span>{{ r.label }}</span>
                  </button>
                </mat-menu>

                <span class="saving-indicator" *ngIf="isSaving(u)">
                  <mat-progress-spinner diameter="16" mode="indeterminate"></mat-progress-spinner>
                </span>
              </div>
            </td>
          </ng-container>

          <!-- status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Statut</th>
            <td mat-cell *matCellDef="let u">
              <span
                class="status-pill"
                [class.active]="isActive(u)"
                [class.inactive]="!isActive(u)"
                [matTooltip]="'Dernière activité : ' + lastSeenLabel(u)"
              >
                <mat-icon>{{ isActive(u) ? 'circle' : 'do_not_disturb_on' }}</mat-icon>
                {{ isActive(u) ? 'Actif' : 'Inactif' }}
              </span>
            </td>
          </ng-container>

          <!-- actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let u" class="actions" (click)="$event.stopPropagation()">
              <button mat-stroked-button color="warn" (click)="deleteUser(u)" [disabled]="isSaving(u)">
                <mat-icon>delete</mat-icon>
                Supprimer
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            class="clickable-row"
            (click)="openUser(row)"
          ></tr>
        </table>
      </div>

      <!-- =========================
           MOBILE : CARDS
           ========================= -->
      <div class="users-cards" *ngIf="!loading && filteredUsers?.length">
        <article
          class="user-card"
          *ngFor="let u of filteredUsers; trackBy: trackById"
          (click)="openUser(u)"
        >
          <div class="uc-top">
            <div class="uc-left">
              <div class="uc-title">
                <mat-icon class="uc-avatar">person</mat-icon>
                <div class="uc-name">
                  <div class="uc-fullName">{{ u.fullName || '—' }}</div>
                  <div class="uc-email mono" [title]="u.email">{{ u.email }}</div>
                </div>
              </div>

              <div class="uc-meta">
                <span class="uc-chip mono">ID #{{ u.id }}</span>
                <span class="uc-chip">Inscrit : {{ formatDate(u.createdAt) }}</span>
              </div>
            </div>

            <span
              class="status-pill"
              [class.active]="isActive(u)"
              [class.inactive]="!isActive(u)"
              (click)="$event.stopPropagation()"
              [matTooltip]="'Dernière activité : ' + lastSeenLabel(u)"
            >
              <mat-icon>{{ isActive(u) ? 'circle' : 'do_not_disturb_on' }}</mat-icon>
              {{ isActive(u) ? 'Actif' : 'Inactif' }}
            </span>
          </div>

          <div class="uc-bottom" (click)="$event.stopPropagation()">
            <div class="role-cell" [class.saving]="isSaving(u)">
              <button
                type="button"
                class="role-badge"
                [class.admin]="u.role === 'ADMIN'"
                [class.editor]="u.role === 'EDITOR'"
                [matMenuTriggerFor]="roleMenuMobile"
                (click)="$event.stopPropagation()"
                [disabled]="isSaving(u)"
                aria-label="Changer le rôle"
              >
                <mat-icon class="role-badge-ic">
                  {{ u.role === 'ADMIN' ? 'verified_user' : (u.role === 'EDITOR' ? 'edit' : 'person') }}
                </mat-icon>
                {{ u.role }}
                <mat-icon class="chev">expand_more</mat-icon>
              </button>

              <mat-menu #roleMenuMobile="matMenu" class="role-menu">
                <button mat-menu-item *ngFor="let r of roleOptions" (click)="setRole(u, r.value)">
                  <mat-icon>{{ r.icon }}</mat-icon>
                  <span>{{ r.label }}</span>
                </button>
              </mat-menu>

              <span class="saving-indicator" *ngIf="isSaving(u)">
                <mat-progress-spinner diameter="16" mode="indeterminate"></mat-progress-spinner>
              </span>
            </div>

            <button
              mat-stroked-button
              color="warn"
              class="uc-delete"
              (click)="$event.stopPropagation(); deleteUser(u)"
              [disabled]="isSaving(u)"
            >
              <mat-icon>delete</mat-icon>
              Supprimer
            </button>
          </div>
        </article>
      </div>
    </mat-card>
  </main>
</div>
