<!-- admin-metrics.component.html -->
<div class="admin-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" role="navigation" aria-label="Menu administration">
    <a class="brand-side" routerLink="/" aria-label="Retour à l’accueil">
      <img
        src="/Logo_AquaManger.png"
        alt="AquaManager"
        class="logo"
        loading="lazy"
        decoding="async"
      />
    </a>

    <div class="sidebar-title">ADMINISTRATION</div>

    <mat-nav-list class="nav">
      <a mat-list-item routerLink="/admin/metrics" routerLinkActive="active">
        <mat-icon matListItemIcon>manage_accounts</mat-icon>
        <span matListItemTitle>Dashboard</span>
      </a>

      <a mat-list-item routerLink="/admin/users" routerLinkActive="active">
        <mat-icon matListItemIcon>group</mat-icon>
        <span matListItemTitle>Utilisateurs</span>
      </a>

      <a mat-list-item routerLink="/admin/species/fish" routerLinkActive="active">
        <mat-icon matListItemIcon>pets</mat-icon>
        <span matListItemTitle>Poissons</span>
      </a>

      <a mat-list-item routerLink="/admin/species/plant" routerLinkActive="active">
        <mat-icon matListItemIcon>local_florist</mat-icon>
        <span matListItemTitle>Plantes</span>
      </a>

      <a mat-list-item routerLink="/admin/articles" routerLinkActive="active">
        <mat-icon matListItemIcon>tips_and_updates</mat-icon>
        <span matListItemTitle>Articles / Conseils</span>
      </a>
    </mat-nav-list>

    <div class="sidebar-footer">
      <a mat-stroked-button class="back-btn" routerLink="/profile" aria-label="Retour au profil">
        <mat-icon>arrow_back</mat-icon>
        Profil
      </a>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="page">
      <mat-toolbar class="toolbar" role="banner">
        <div class="brand">
          <div class="brand-icon" aria-hidden="true">
            <mat-icon>query_stats</mat-icon>
          </div>
          <div class="brand-text">
            <div class="brand-title">Dashboard Admin</div>
            <div class="brand-sub" *ngIf="metrics">
              {{ rangeLabel() }} • Généré le {{ metrics.generatedAt | date:'medium' }}
            </div>
          </div>
        </div>

        <span class="spacer"></span>

        <div class="range-wrap" aria-label="Période">
          <!-- ✅ onRangeChange au lieu de click sur chaque bouton -->
          <mat-button-toggle-group class="range" [value]="range" (change)="onRangeChange($event)">
            <mat-button-toggle value="1d">24h</mat-button-toggle>
            <mat-button-toggle value="7d">7j</mat-button-toggle>
            <mat-button-toggle value="30d">30j</mat-button-toggle>
            <mat-button-toggle value="365d">1 an</mat-button-toggle>
            <mat-button-toggle value="all">Total</mat-button-toggle>
          </mat-button-toggle-group>
        </div>
      </mat-toolbar>

      <div class="state" *ngIf="loading">
        <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
        <span>Chargement…</span>
      </div>

      <div class="state error" *ngIf="error">
        <mat-icon>error</mat-icon>
        <span>{{ error }}</span>
      </div>

      <ng-container *ngIf="metrics && !loading">
        <section class="grid">
          <!-- USERS -->
          <mat-card class="kpi kpi-users">
            <div class="kpi-top">
              <div class="kpi-icon" aria-hidden="true"><mat-icon>group</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Utilisateurs</div>
                <div class="kpi-value">{{ metrics.users.total }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="kpi-rows">
              <div class="row">
                <span>Nouveaux sur la période</span>
                <b>{{ kpi(metrics.users.newInRange) }}</b>
              </div>

              <div class="row">
                <span>Actifs sur la période</span>
                <b>{{ metrics.users.activeInRange }}</b>
              </div>

              <div class="row">
                <span>Taux d’activité</span>
                <b>{{ pct(metrics.users.activeInRange, metrics.users.total) }}</b>
              </div>

              <div class="row">
                <span>Admins (total)</span>
                <b>{{ metrics.users.admins }}</b>
              </div>
            </div>

            <div class="note" *ngIf="metrics.users.note">
              <mat-icon aria-hidden="true">info</mat-icon>
              <span>{{ metrics.users.note }}</span>
            </div>
          </mat-card>

          <!-- AQUARIUMS -->
          <mat-card class="kpi kpi-aqua">
            <div class="kpi-top">
              <div class="kpi-icon" aria-hidden="true"><mat-icon>waves</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Aquariums</div>
                <div class="kpi-value">{{ metrics.aquariums.total }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="kpi-rows">
              <div class="row">
                <span>Créés sur la période</span>
                <b>{{ metrics.aquariums.createdInRange }}</b>
              </div>
            </div>
          </mat-card>

          <!-- MEASUREMENTS -->
          <mat-card class="kpi kpi-measures">
            <div class="kpi-top">
              <div class="kpi-icon" aria-hidden="true"><mat-icon>science</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Mesures</div>
                <div class="kpi-value">{{ metrics.measurements.total }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="kpi-rows">
              <div class="row">
                <span>Ajoutées sur la période</span>
                <b>{{ metrics.measurements.createdInRange }}</b>
              </div>

              <div class="row">
                <span>Moyenne / aquarium</span>
                <b>{{ avg(metrics.measurements.total, metrics.aquariums.total, 1) }}</b>
              </div>
            </div>
          </mat-card>

          <!-- TASKS -->
          <mat-card class="kpi kpi-tasks">
            <div class="kpi-top">
              <div class="kpi-icon" aria-hidden="true"><mat-icon>checklist</mat-icon></div>
              <div class="kpi-meta">
                <div class="kpi-label">Tâches</div>
                <div class="kpi-value">{{ metrics.tasks.total }}</div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="kpi-rows">
              <div class="row">
                <span>Créées sur la période</span>
                <b>{{ metrics.tasks.createdInRange }}</b>
              </div>
            </div>
          </mat-card>
        </section>

        <!-- ✅ GRAPH : nouveaux utilisateurs -->
        <mat-card class="chart-card">
          <div class="chart-head">
            <div class="chart-head-text">
              <h2>Nouveaux utilisateurs</h2>
              <p>Évolution sur {{ rangeLabel() }}.</p>
            </div>
            <mat-icon aria-hidden="true">show_chart</mat-icon>
          </div>

          <div class="chart-wrap" *ngIf="hasNewUsersSeries(); else noSeries">
            <div
              class="chart-line"
              role="img"
              aria-label="Graphique (courbe) des nouveaux utilisateurs"
              (mousemove)="onChartMove($event)"
              (mouseleave)="onChartLeave()"
            >
              <svg class="chart-svg" viewBox="0 0 1000 260" preserveAspectRatio="none" aria-hidden="true">
                <g class="grid">
                  <line x1="0" y1="52" x2="1000" y2="52"></line>
                  <line x1="0" y1="104" x2="1000" y2="104"></line>
                  <line x1="0" y1="156" x2="1000" y2="156"></line>
                  <line x1="0" y1="208" x2="1000" y2="208"></line>
                </g>

                <path class="area" [attr.d]="lineAreaPath()"></path>
                <path class="line" [attr.d]="linePath()"></path>

                <g class="points">
                  <circle
                    *ngFor="let pt of linePoints(); let i = index"
                    class="pt"
                    [class.active]="i === hoverIndex"
                    [attr.cx]="pt.x"
                    [attr.cy]="pt.y"
                    (mouseenter)="setHoverIndex(i)"
                  ></circle>
                </g>

                <line
                  *ngIf="hoverIndex !== null && safePoint(hoverIndex)"
                  class="cursor"
                  [attr.x1]="safePoint(hoverIndex)!.x"
                  [attr.x2]="safePoint(hoverIndex)!.x"
                  y1="0"
                  y2="260"
                ></line>
              </svg>

              <div
                class="tip"
                *ngIf="hoverIndex !== null && newUsersSeries()[hoverIndex]"
                [style.left.px]="tipLeft"
                [style.top.px]="tipTop"
              >
                <div class="tip-title">{{ newUsersSeries()[hoverIndex].label }}</div>
                <div class="tip-value">{{ newUsersSeries()[hoverIndex].count }} inscrit(s)</div>
              </div>

              <div class="xlabels" aria-hidden="true">
                <span
                  *ngFor="let p of newUsersSeries(); let i = index"
                  class="xl"
                  [class.show]="i === 0 || i === newUsersSeries().length - 1 || i % 6 === 0"
                >
                  {{ p.label }}
                </span>
              </div>
            </div>

            <div class="chart-hint" *ngIf="seriesHint()">
              <mat-icon aria-hidden="true">info</mat-icon>
              <span>{{ seriesHint() }}</span>
            </div>
          </div>

          <ng-template #noSeries>
            <div class="chart-empty">
              <mat-icon>insights</mat-icon>
              <div>
                <div class="chart-empty-title">Pas de données de série</div>
                <div class="chart-empty-sub">evolution inscriptions</div>
              </div>
            </div>
          </ng-template>
        </mat-card>
        <!-- ✅ GRAPH : utilisateurs actifs -->
<mat-card class="chart-card">
  <div class="chart-head">
    <div class="chart-head-text">
      <h2>Utilisateurs actifs</h2>
      <p>Utilisateurs ayant créé une tâche ou une mesure sur {{ rangeLabel() }}.</p>
    </div>
    <mat-icon aria-hidden="true">insights</mat-icon>
  </div>

  <div class="chart-wrap" *ngIf="hasActiveUsersSeries(); else noActiveSeries">
    <div
      class="chart-line"
      role="img"
      aria-label="Graphique (courbe) des utilisateurs actifs"
      (mousemove)="onActiveChartMove($event)"
      (mouseleave)="onActiveChartLeave()"
    >
      <svg class="chart-svg" viewBox="0 0 1000 260" preserveAspectRatio="none" aria-hidden="true">
        <g class="grid">
          <line x1="0" y1="52" x2="1000" y2="52"></line>
          <line x1="0" y1="104" x2="1000" y2="104"></line>
          <line x1="0" y1="156" x2="1000" y2="156"></line>
          <line x1="0" y1="208" x2="1000" y2="208"></line>
        </g>

        <path class="area" [attr.d]="activeLineAreaPath()"></path>
        <path class="line" [attr.d]="activeLinePath()"></path>

        <g class="points">
          <circle
            *ngFor="let pt of activeLinePoints(); let i = index"
            class="pt"
            [class.active]="i === activeHoverIndex"
            [attr.cx]="pt.x"
            [attr.cy]="pt.y"
            (mouseenter)="setActiveHoverIndex(i)"
          ></circle>
        </g>

        <line
          *ngIf="activeHoverIndex !== null && safeActivePoint(activeHoverIndex)"
          class="cursor"
          [attr.x1]="safeActivePoint(activeHoverIndex)!.x"
          [attr.x2]="safeActivePoint(activeHoverIndex)!.x"
          y1="0"
          y2="260"
        ></line>
      </svg>

      <div
        class="tip"
        *ngIf="activeHoverIndex !== null && activeUsersSeries()[activeHoverIndex]"
        [style.left.px]="activeTipLeft"
        [style.top.px]="activeTipTop"
      >
        <div class="tip-title">{{ activeUsersSeries()[activeHoverIndex].label }}</div>
        <div class="tip-value">{{ activeUsersSeries()[activeHoverIndex].count }} actif(s)</div>
      </div>

      <div class="xlabels" aria-hidden="true">
        <span
          *ngFor="let p of activeUsersSeries(); let i = index"
          class="xl"
          [class.show]="i === 0 || i === activeUsersSeries().length - 1 || i % 6 === 0"
        >
          {{ p.label }}
        </span>
      </div>
    </div>
  </div>

  <ng-template #noActiveSeries>
    <div class="chart-empty">
      <mat-icon>insights</mat-icon>
      <div>
        <div class="chart-empty-title">Pas de données d’activité</div>
        <div class="chart-empty-sub">Aucun événement sur la période.</div>
      </div>
    </div>
  </ng-template>
</mat-card>


        <mat-card class="table-card">
          <div class="table-head">
            <div class="table-head-text">
              <h2>Derniers utilisateurs</h2>
              <p>Les derniers comptes créés (utile pour valider les rôles / inscriptions).</p>
            </div>
            <mat-icon aria-hidden="true">manage_accounts</mat-icon>
          </div>

          <div class="table-wrap">
            <table mat-table [dataSource]="metrics.users.latest" class="mat-elevation-z0">
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let u">{{ u.id }}</td>
              </ng-container>

              <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef>Nom</th>
                <td mat-cell *matCellDef="let u">{{ u.fullName }}</td>
              </ng-container>

              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>Email</th>
                <td mat-cell *matCellDef="let u">{{ u.email }}</td>
              </ng-container>

              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef>Rôle</th>
                <td mat-cell *matCellDef="let u">
                  <mat-chip-set>
                    <mat-chip class="chip" [ngClass]="roleClass(u.role)">
                      {{ roleLabel(u.role) }}
                    </mat-chip>
                  </mat-chip-set>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
        </mat-card>
      </ng-container>
    </div>
  </main>
</div>
