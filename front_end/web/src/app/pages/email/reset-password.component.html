<div class="wrap">
  <mat-card class="card">
    <div class="head">
      <div class="icon">
        <mat-icon>lock_reset</mat-icon>
      </div>
      <div class="titles">
        <h1>Réinitialiser le mot de passe</h1>
        <p class="sub">Choisis un nouveau mot de passe sécurisé pour ton compte.</p>
      </div>
    </div>

    <div class="notice" *ngIf="!token && errorMsg()">
      <mat-icon>error</mat-icon>
      <span>{{ errorMsg() }}</span>
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()" *ngIf="token">
      <div formGroupName="passwords" class="fields">
        <mat-form-field appearance="outline" class="full">
          <mat-label>Nouveau mot de passe</mat-label>
          <input
            matInput
            [type]="hidePwd() ? 'password' : 'text'"
            formControlName="newPassword"
            autocomplete="new-password"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hidePwd.set(!hidePwd())"
            [attr.aria-label]="'Afficher/Masquer le mot de passe'"
          >
            <mat-icon>{{ hidePwd() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>

          <mat-hint>8+ caractères, maj/min, chiffre, caractère spécial</mat-hint>
          <mat-error *ngIf="newPassword?.hasError('required')">Mot de passe requis</mat-error>
          <mat-error *ngIf="newPassword?.hasError('minlength')">Minimum 8 caractères</mat-error>
          <mat-error *ngIf="newPassword?.hasError('pattern')">Format trop faible</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Confirmer le mot de passe</mat-label>
          <input
            matInput
            [type]="hideCfm() ? 'password' : 'text'"
            formControlName="confirmPassword"
            autocomplete="new-password"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hideCfm.set(!hideCfm())"
            [attr.aria-label]="'Afficher/Masquer la confirmation'"
          >
            <mat-icon>{{ hideCfm() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>

          <mat-error *ngIf="confirmPassword?.hasError('required')">Confirmation requise</mat-error>
        </mat-form-field>

        <div class="inline-error" *ngIf="passwords.errors?.['passwordsMismatch']">
          <mat-icon>warning</mat-icon>
          <span>Les mots de passe ne correspondent pas.</span>
        </div>
      </div>

      <div class="alert error" *ngIf="errorMsg()">
        <mat-icon>error</mat-icon>
        <span>{{ errorMsg() }}</span>
      </div>

      <div class="alert ok" *ngIf="successMsg()">
        <mat-icon>check_circle</mat-icon>
        <span>{{ successMsg() }}</span>
      </div>

      <button
        mat-flat-button
        color="primary"
        class="cta"
        type="submit"
        [disabled]="loading() || form.invalid"
      >
        <mat-icon *ngIf="!loading()">check</mat-icon>
        <mat-spinner *ngIf="loading()" diameter="18"></mat-spinner>
        <span>Valider</span>
      </button>

      <div class="actions">
        <a mat-button routerLink="/login">
          <mat-icon>arrow_back</mat-icon>
          Retour connexion
        </a>
      </div>
    </form>

    <div class="foot">
      <mat-icon>security</mat-icon>
      <span>Ton mot de passe est chiffré et jamais stocké en clair.</span>
    </div>
  </mat-card>
</div>
